name: Build VisionClaw Unsigned IPA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.2 (Swift 6.2)
        run: sudo xcode-select -s /Applications/Xcode_16.4.app

      # 1. CREATE SECRETS.SWIFT
      # Using an environment variable for the secret is the safest way to handle special characters.
      - name: Create Secrets.swift
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          DIRECTORY="samples/CameraAccess/CameraAccess"
          mkdir -p "$DIRECTORY"
          
          # Use the env variable to prevent shell expansion issues
          printf 'import Foundation\n\nenum Secrets {\n  static let geminiAPIKey = "%s"\n  static let openClawHost = "http://localhost.local"\n  static let openClawPort = 18789\n  static let openClawHookToken = "none"\n  static let openClawGatewayToken = "none"\n}\n' "$GEMINI_KEY" > "$DIRECTORY/Secrets.swift"
          
          echo "Secrets.swift created."

      # 2. PATCH SOURCE CODE FOR SWIFT 6 COMPATIBILITY
      # The compiler complained that 'execute' isn't concurrency-safe. 
      # We add @MainActor to satisfy the Swift 6 compiler.
      - name: Patch ToolCallModels.swift
        run: |
          TARGET_FILE="samples/CameraAccess/CameraAccess/OpenClaw/ToolCallModels.swift"
          if [ -f "$TARGET_FILE" ]; then
            sed -i '' 's/static let execute: \[String: Any\]/@MainActor static let execute: \[String: Any\]/g' "$TARGET_FILE"
            echo "Successfully patched ToolCallModels.swift with @MainActor"
          else
            echo "Warning: ToolCallModels.swift not found, skipping patch."
          fi

      # 3. INSTALL DEPENDENCIES
      - name: Install Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "samples/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess"

      # 4. BUILD APP (SWIFT 6 MODE)
      - name: Build App
        run: |
          xcodebuild build \
            -project "samples/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            SWIFT_VERSION=6.0 \
            OTHER_SWIFT_FLAGS="-suppress-warnings"

      # 5. PACKAGE INTO IPA
      - name: Package into IPA
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "CameraAccess.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: Could not find CameraAccess.app"
            exit 1
          fi
          
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r VisionClaw_CameraAccess.ipa Payload

      # 6. UPLOAD ARTIFACT
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisionClaw-IPA
          path: VisionClaw_CameraAccess.ipa
