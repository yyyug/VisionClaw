name: Build VisionClaw Unsigned IPA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      # 1. CREATE THE SECRETS.SWIFT FILE
      # This creates the file that was gitignored and fills in your Gemini Key
      - name: Create Secrets.swift and Inject Key
        run: |
          DIRECTORY="samples/CameraAccess/CameraAccess/Gemini"
          FILE="$DIRECTORY/Secrets.swift"
          
          echo "Creating $FILE..."
          
          # We use cat to write the exact Swift structure required by the project
          cat <<EOF > "$FILE"
          import Foundation

          enum Secrets {
            // Secret injected from GitHub Actions
            static let geminiAPIKey = "${{ secrets.GEMINI_API_KEY }}"

            // Optional OpenClaw values (set to defaults as they aren't required for basic use)
            static let openClawHost = "http://localhost.local"
            static let openClawPort = 18789
            static let openClawHookToken = "none"
            static let openClawGatewayToken = "none"
          }
          EOF
          
          echo "Secrets.swift created successfully."

      # 2. INSTALL DEPENDENCIES
      - name: Install Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "samples/CameraAccess/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess"

      # 3. BUILD APP (NO SIGNING)
      - name: Build App
        run: |
          xcodebuild build \
            -project "samples/CameraAccess/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess" \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      # 4. PACKAGE INTO IPA
      - name: Package into IPA
        run: |
          # Find the app folder inside the build results
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "CameraAccess.app" -type d | head -n 1)
          
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r VisionClaw_CameraAccess.ipa Payload

      # 5. UPLOAD ARTIFACT
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisionClaw-IPA-File
          path: VisionClaw_CameraAccess.ipa
