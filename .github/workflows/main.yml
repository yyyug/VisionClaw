name: Build VisionClaw Unsigned IPA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15 # Use macOS 15 to ensure Xcode 16.2 is available
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        # We need this compiler version to read the Meta SDK modules (Swift 6.2)
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      # 1. CREATE SECRETS.SWIFT
      - name: Create Secrets.swift
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 -c "
          import os
          key = os.environ.get('GEMINI_KEY', '').strip()
          content = f'''import Foundation
          enum Secrets {{
              static let geminiAPIKey = \"{key}\"
              static let openClawHost = \"http://localhost.local\"
              static let openClawPort = 18789
              static let openClawHookToken = \"none\"
              static let openClawGatewayToken = \"none\"
          }}
          '''
          os.makedirs('samples/CameraAccess/CameraAccess', exist_ok=True)
          with open('samples/CameraAccess/CameraAccess/Secrets.swift', 'w') as f:
              f.write(content)
          "

      # 2. INSTALL DEPENDENCIES
      - name: Install Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "samples/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess"

      # 3. BUILD APP (SWIFT 5 LANGUAGE MODE)
      # We force SWIFT_VERSION=5.0 so the compiler doesn't enforce Swift 6 strictness
      - name: Build App
        run: |
          xcodebuild archive \
            -project "samples/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess" \
            -sdk iphoneos \
            -archivePath "build/CameraAccess.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            SWIFT_VERSION=5.0 \
            SWIFT_STRICT_CONCURRENCY=minimal \
            OTHER_SWIFT_FLAGS="-suppress-warnings"

      # 4. PACKAGE INTO IPA
      - name: Package into IPA
        run: |
          mkdir -p Payload
          cp -r build/CameraAccess.xcarchive/Products/Applications/CameraAccess.app Payload/
          zip -r VisionClaw_CameraAccess.ipa Payload

      # 5. UPLOAD ARTIFACT
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisionClaw-IPA
          path: VisionClaw_CameraAccess.ipa
