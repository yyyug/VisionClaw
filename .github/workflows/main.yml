name: Build VisionClaw Unsigned IPA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    # Use macOS 15 to get access to Xcode 16.2
    runs-on: macos-15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.2 (Swift 6.2)
        # This version is REQUIRED to link against Meta SDK v0.4.0
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      # 1. CREATE SECRETS.SWIFT
      - name: Create Secrets.swift
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 -c "
          import os
          key = os.environ.get('GEMINI_KEY', '').strip()
          content = f'''import Foundation
          enum Secrets {{
              static let geminiAPIKey = \"{key}\"
              static let openClawHost = \"http://localhost.local\"
              static let openClawPort = 18789
              static let openClawHookToken = \"none\"
              static let openClawGatewayToken = \"none\"
          }}
          '''
          os.makedirs('samples/CameraAccess/CameraAccess', exist_ok=True)
          with open('samples/CameraAccess/CameraAccess/Secrets.swift', 'w') as f:
              f.write(content)
          "

      # 2. AGGRESSIVE SOURCE PATCHING
      # This fixes the Concurrency/Sendable errors that cause Exit 65
      - name: Patch Source for Swift 6.2 Compatibility
        run: |
          python3 -c "
          import os, re

          def apply_patch(path, pattern, replacement):
              if not os.path.exists(path): return
              with open(path, 'r') as f: content = f.read()
              if re.search(pattern, content):
                  with open(path, 'w') as f: f.write(re.sub(pattern, replacement, content))
                  print(f'Patched: {path}')

          # Fix A: ToolCallModels - add @MainActor to static property
          apply_patch('samples/CameraAccess/CameraAccess/OpenClaw/ToolCallModels.swift',
                      r'static\s+let\s+execute', 
                      '@MainActor static let execute')

          # Fix B: GeminiLiveService - make WebSocketDelegate safe for Swift 6
          apply_patch('samples/CameraAccess/CameraAccess/Gemini/GeminiLiveService.swift',
                      r'class\s+WebSocketDelegate\s*:\s*NSObject\s*,\s*URLSessionWebSocketDelegate', 
                      'final class WebSocketDelegate: NSObject, URLSessionWebSocketDelegate, @unchecked Sendable')

          # Fix C: Mark main ViewModels as Sendable to satisfy Meta DAT's ListenerStore<T>
          # We search for class definitions and add @unchecked Sendable
          files_to_sendable = [
              'samples/CameraAccess/CameraAccess/ViewModels/WearablesViewModel.swift',
              'samples/CameraAccess/CameraAccess/ViewModels/StreamSessionViewModel.swift'
          ]
          for path in files_to_sendable:
              apply_patch(path, r'class\s+(\w+)\s*:\s*ObservableObject', r'class \1: ObservableObject, @unchecked Sendable')
          "

      # 3. FORCE PROJECT SETTINGS (Critical for Swift 6.2)
      - name: Override Project Settings
        run: |
          PROJ="samples/CameraAccess/CameraAccess.xcodeproj/project.pbxproj"
          # Physically set project to Swift 5 mode to avoid 100+ concurrency errors, 
          # while the 6.2 compiler handles the SDK linking.
          sed -i '' 's/SWIFT_VERSION = 6.0/SWIFT_VERSION = 5.0/g' "$PROJ"
          sed -i '' 's/SWIFT_STRICT_CONCURRENCY = complete/SWIFT_STRICT_CONCURRENCY = minimal/g' "$PROJ"
          sed -i '' 's/SWIFT_STRICT_CONCURRENCY = targeted/SWIFT_STRICT_CONCURRENCY = minimal/g' "$PROJ"

      # 4. INSTALL DEPENDENCIES
      - name: Install Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "samples/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess"

      # 5. BUILD APP (UNSIGNED)
      - name: Build App
        run: |
          xcodebuild build \
            -project "samples/CameraAccess/CameraAccess.xcodeproj" \
            -scheme "CameraAccess" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            IPHONEOS_DEPLOYMENT_TARGET=17.0 \
            OTHER_SWIFT_FLAGS="-suppress-warnings -Xfrontend -disable-implicit-concurrency-module-import"

      # 6. PACKAGE INTO IPA
      - name: Package into IPA
        run: |
          # Robust search for the built .app
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "CameraAccess.app" -type d | grep "Debug-iphoneos" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: Could not find CameraAccess.app"
            exit 1
          fi
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r VisionClaw_CameraAccess.ipa Payload

      # 7. UPLOAD ARTIFACT
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisionClaw-IPA
          path: VisionClaw_CameraAccess.ipa
